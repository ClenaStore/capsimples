<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CAP Simplificado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- üîπ √çcone -->
<link rel="icon" type="image/png" href="https://github.com/ClenaStore/capsimples/blob/main/paste/Design%20sem%20nome%20(25).png?raw=true" />
<link rel="apple-touch-icon" href="https://github.com/ClenaStore/capsimples/blob/main/paste/Design%20sem%20nome%20(25).png?raw=true" />

<!-- üîπ Meta compartilhamento -->
<meta property="og:title" content="CAP Simplificado" />
<meta property="og:description" content="Painel de acompanhamento de parcelas aprovadas" />
<meta property="og:image" content="https://github.com/ClenaStore/capsimples/blob/main/paste/Design%20sem%20nome%20(25).png?raw=true" />
<meta property="og:url" content="https://clenastore.github.io/capsimples/" />
<meta property="og:type" content="website" />

<style>
  body{margin:0;font-family:Arial, sans-serif;background:#0b1220;color:#e5f0ff}
  header{padding:12px;background:#101a2f;position:sticky;top:0;z-index:10}
  h1{margin:0 0 10px;font-size:18px}
  select,input,button{padding:6px;border-radius:6px;border:1px solid #22314b;background:#0b1528;color:#e5f0ff;font-size:14px}
  .filtros{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .somas{margin:10px 0;padding:10px;background:#101a2f;border:1px solid #22314b;border-radius:6px;font-size:14px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #22314b;text-align:left;vertical-align:top}
  th{background:#101a2f}
  .status{font-weight:600}
  .status.aprovado{color:#16a34a}
  .status.negado{color:#ef4444}
  .status.pendente{color:#f59e0b}
  .status.liquidado{color:#3b82f6}
  b.obs-leonardo{color:#ef4444;font-weight:700}
  tr.linha-confirmada {background-color:rgba(22,163,74,0.15);transition:background 0.3s ease;}
  button.mass-action {margin-left:auto;background:#16a34a;cursor:pointer}

  /* Overlay de carregamento */
  #overlay {
    position: fixed;
    top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-size:20px;
    z-index:9999;
  }
</style>
</head>
<body>
<header>
  <h1>CAP Simplificado</h1>
  <div class="filtros">
    <select id="filtroStatus">
      <option value="">Todos Status</option>
      <option value="Aprovado" selected>Aprovados</option>
      <option>Negado</option>
      <option>Pendente</option>
      <option>Liquidado</option>
    </select>
    <select id="filtroMeio">
      <option value="">Todos Meios</option>
      <option>PIX</option>
      <option>Cart√£o</option>
      <option>Boleto</option>
      <option>Outros</option>
    </select>
    <select id="filtroEmpresa">
      <option value="cap delicia">DEL√çCIA GOURMET</option>
      <option value="cap villa">VILLA GOURMET</option>
      <option value="cap padaria">PADARIA DEL√çCIA</option>
      <option value="cap mercatto" selected>MERCATTO</option>
      <option value="cap m.kids">M.KIDS</option>
    </select>
    <input type="text" id="barraPesquisa" placeholder="üîç Pesquisar..." />
    <button class="mass-action" onclick="liquidarMassa()">‚úì Liquidar em Massa</button>
  </div>
</header>

<div class="container" style="padding:10px">
  <div class="somas" id="somas"></div>
  <table>
    <thead>
      <tr>
        <th>Fornecedor</th>
        <th>Empresa</th>
        <th>Vencimento</th>
        <th>Meio</th>
        <th>Valor</th>
        <th>Hist√≥rico</th>
        <th>Obs Leonardo</th>
        <th>Status</th>
        <th>Liquidar</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<!-- Overlay -->
<div id="overlay">üîÑ Carregando dados...</div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbzJS4UkF6WZ-duyMJW_h3e5fo4Hev6Hq1a7rGhWNYCNJ6V_ou0lkN6wS49eeANf4Yuy/exec";
const EMPRESAS=["cap delicia","cap villa","cap padaria","cap mercatto","cap m.kids"];
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => {const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};
let TODOS=[], FILTRADOS=[];

function render(){
  const lista=document.getElementById("lista");
  lista.innerHTML="";
  const status=document.getElementById("filtroStatus").value;
  const meio=document.getElementById("filtroMeio").value;
  const empresa=document.getElementById("filtroEmpresa").value;
  const termo=document.getElementById("barraPesquisa").value.toLowerCase();

  FILTRADOS=TODOS.filter(t=>{
    if(status && (t.status||"").toLowerCase().trim() !== status.toLowerCase().trim()) return false;
    if(meio && (t.meio_pagamento||"").toLowerCase().trim() !== meio.toLowerCase().trim()) return false;
    if(empresa && (t.empresa||"").toLowerCase().trim() !== empresa.toLowerCase().trim()) return false;
    if(termo && ![t.fornecedor,t.empresa,t.meio_pagamento,t.status,t.historico,t.observacao].some(v=>v?.toLowerCase().includes(termo))) return false;
    return true;
  });

  // somas
  let somas={},total=0;
  FILTRADOS.forEach(t=>{
    const m=t.meio_pagamento||"Outros";
    const v=parseFloat(t.valor)||0;
    somas[m]=(somas[m]||0)+v;
    total+=v;
  });
  let resumo=Object.entries(somas).map(([m,v])=>`${m}: <b>${BRL(v)}</b>`).join(" ‚Ä¢ ");
  resumo+=` ‚Ä¢ Total: <b>${BRL(total)}</b>`;
  document.getElementById("somas").innerHTML=resumo;

  FILTRADOS.forEach(t=>{
    const tr=document.createElement("tr");
    if(t.status==="Liquidado") tr.classList.add("linha-confirmada");
    const historico=(t.historico||"-").toString().replace(/\n/g,"<br>");
    const obs=(t.observacao||"-").toString().replace(/\n/g,"<br>");
    tr.innerHTML=`
      <td>${t.fornecedor||"-"}</td>
      <td>${t.empresa||"-"}</td>
      <td>${iso(t.vencimento).split("-").reverse().join("/")}</td>
      <td>${t.meio_pagamento||"Outros"}</td>
      <td>${BRL(parseFloat(t.valor)||0)}</td>
      <td>${historico}</td>
      <td><b class="obs-leonardo">${obs}</b></td>
      <td class="status ${(t.status||"").toLowerCase()}">${t.status||"-"}</td>
      <td><input type="checkbox" ${t.status==="Liquidado"?"checked":""} ${t.status==="Negado"||t.status==="Pendente"?"disabled":""} onchange="toggleStatus(this,'${t.empresa}','${t.linha}')"></td>
    `;
    lista.appendChild(tr);
  });
}

async function toggleStatus(chk,emp,linha){
  const tr=chk.closest("tr");
  const tdStatus=tr.querySelector(".status");
  let novoStatus = chk.checked ? "Liquidado" : "Aprovado";
  try{
    const r=await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=${novoStatus}`);
    const txt=await r.text();
    if(!(txt.includes("sucesso")||txt.includes("success"))){
      alert("Erro: "+txt);
      chk.checked=!chk.checked;
    }else{
      tdStatus.textContent=novoStatus;
      tdStatus.className="status "+novoStatus.toLowerCase();
      if(novoStatus==="Liquidado"){
        tr.classList.add("linha-confirmada");
      }else{
        tr.classList.remove("linha-confirmada");
      }
    }
  }catch(e){
    console.error(e);
    chk.checked=!chk.checked;
  }
}

async function liquidarMassa(){
  if(FILTRADOS.length===0) return alert("Nenhum t√≠tulo encontrado nos filtros atuais.");
  if(!confirm(`Deseja liquidar ${FILTRADOS.length} t√≠tulos filtrados?`)) return;
  
  for(const t of FILTRADOS){
    if(t.status==="Aprovado"){
      try{
        const r=await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(t.empresa)}&linha=${t.linha}&status=Liquidado`);
        const txt=await r.text();
        if(txt.includes("sucesso")||txt.includes("success")){
          const tr=[...document.querySelectorAll("#lista tr")].find(row=>row.children[0].innerText===t.fornecedor);
          if(tr){
            tr.classList.add("linha-confirmada");
            const tdStatus=tr.querySelector(".status");
            tdStatus.textContent="Liquidado";
            tdStatus.className="status liquidado";
            tr.querySelector("input[type=checkbox]").checked=true;
          }
        }
      }catch(e){console.error("Erro ao liquidar em massa",t,e);}
    }
  }
}

async function refresh(){
  const empresa=document.getElementById("filtroEmpresa").value;
  document.getElementById("overlay").style.display="flex"; // mostra overlay
  try{
    const r=await fetch(`${endpoint}?action=listar&empresa=${encodeURIComponent(empresa)}`);
    const data=await r.json();
    TODOS=(data.titulos||data).map(t=>({...t,empresa}));
    render();
  }catch(e){console.error(e);}
  finally{
    document.getElementById("overlay").style.display="none"; // esconde overlay
  }
}

["filtroStatus","filtroMeio","filtroEmpresa"].forEach(id=>document.getElementById(id).onchange=refresh);
document.getElementById("barraPesquisa").oninput=render;
refresh();
setInterval(refresh,10000);
</script>
</body>
</html>
